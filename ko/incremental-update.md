---
layout: default
---

**[Home](https://planepaper.github.io/ko/) >> Incremental Update**

# Incremental Update

## 개요

때는 2021년, 내가 산업 기능 요원으로서 회사에서 일을 할 때이다.


당시 재직중이던 회사에서는 자사의 AWS S3로부터 어떤 1MB 파일을 고객들에게 매번 제공하고 있었습니다. 
이 파일은 고객들에게 매우 중요한 파일로, 내용이 변경되는 즉시 고객들이 다시 다운 받아야 했습니다. 하지만 해당 파일은 하루에 7번정도 내용이 빈번히 변경되었고, 변경 내용은 극히 적은데, 기존 클라이언트는 해당 1mb파일 전체를 전부 다시 받아야 했습니다. 그 때문에 해당 트래픽으로 드는 비용이 굉장히 비싸다는 문제가 있었습니다.

따라서 비용을 절감을 목적으로, 회사는 저에게 증분 업데이트 기능 개발을 부탁했습니다.
전체 파일이 아닌 변경 사항만을 담은 패치파일을 배포해 고객들 PC에서 패치할 수 있도록 만들어야 했습니다.

이 1mb 파일의 내용 변경은 다른 부서에서 이루어졌습니다. 때문에 저는 기존 일 처리 방식을 최대한 유지하는 방향으로 기능을 검토했습니다. 
다른 부서에서 1mb파일을 변경하고 업로드 시, 자동화 trigger가 작동되어 직전 업로드 파일과 현 파일의 diff로 패치파일을 만들도록 했습니다. 
그리고 이 패치 파일을 서버에 자동으로 배포한 뒤, 클라이언트에서 해당 패치파일을 현 1mb파일에 적용할 수 있도록 하게 만들었습니다. 패치 파일 생성과 적용에는 bsdiff 오픈소스 라이브러리를 이용하였습니다. 
결과적으로 기능을 성공적으로 개발하고 배포해, 총 60%의 비용을 절감할 수 있었습니다.


## 어려웠던 점

기존의 업데이트 로직에 제가 원하는 기능을 새롭게 이식하는 것이 굉장히 어려웠습니다.
제가 담당했던 소프트웨어는 VS2003 환경에 약 20년 정도 된 소프트웨어였고 업데이트 로직 부분이 그간 리팩토링되지 않았습니다. 그래서 누구도 새로운 기능을 쉽게 추가할 수 없는 상황이었습니다. 따라서 신입사원인 제가 해당 코드들을 전부 분석하고 새로운 기능을 삽입, 그리고 테스트 환경을 구성하는 것이 굉장히 힘들었습니다.

그래서 먼저, 개발하고자 하는 기능만을 VS2019 환경에서 정적라이브러리로 만들었습니다. 그리고, google test 라이브러리와 nginx 웹서버의 미리 만들어놓은 패치파일들을 활용해 자동으로 테스트를 진행했습니다. 그렇게 안정된 기능을 확인한 후에 해당 기능을 기존 VS2003상의 업데이트 로직에 포함시켜 전체 동작을 확인했습니다.

하지만 배포한 결과, 기존 트래픽이 오히려 3배 늘어났습니다.
기존 업데이트 로직이 어떤 특수한 상황에서 그 즉시 3번이상 업데이트 시도하던 것이 문제 였습니다. 그 때문에 제 증분 업데이트 코드가 3번 이상 동작하며 비정상적인 트래픽이 발생했던 것입니다.
단기간의 개발이었기 때문에, End-to-end 테스트를 자동화가 아닌 수동으로 하다 놓친 문제였습니다.
이후, 저는 문제를 신속히 회사에 알리고 롤백 시켰습니다. 그리고 기존 업데이트 로직을 좀더 꼼꼼히 살피고 end-to-end 테스트를 자동화로 구성했습니다. 안정성을 점검 후 다시 배포한 결과, 트래픽을 잘 줄일 수 있었습니다.
