---
layout: default
---

**[Home](https://planepaper.github.io/ko/) >> Incremental Update**

# 増分アップデート

## 概要
大学時代に勤めていた会社で増分アップデート機能を一人で開発しました。増分アップデートとは、変更された部分のパッチファイルをダウンロードしてローカルの既存ファイルにパッチし、ファイルをアップデートする方式です。

会社ではAWS3から1MBファイルを顧客に毎回提供していました。 
このファイルは非常に重要なファイルで顧客は内容が変更されるたびダウンロードする必要がありました。しかし、該当ファイルは内容が頻繁に変更され、変更内容は極めて少ないにも関わらずファイル全体を再度ダウンロードする必要がありました。そのため、トラフィック費用が非常に高い問題がありました。

そこで、コスト削減を目的に会社から私に増分更新機能の開発を依頼しました。
フルファイルではなく、変更内容のみをパッチファイルで配布し、顧客のPCでパッチできる仕組みを作る必要がありました。

私は、他の部署で1MBファイルを変更・アップロードする際、自動化トリガーが作動し、直前のアップロードファイルと現ファイルのdiffでパッチファイルを作るようにしました。 
そして、このパッチファイルをサーバーに自動的に配布した後、顧客が当該パッチファイルを現在の1MBファイルに適用できるようにしました。 パッチファイルの生成と適用にはbsdiffオープンソースライブラリを利用しました。 

その結果、機能の開発に成功し、合計60%のコストを削減できました。

## 難しかった点
既存のアップデートロジックに機能を新しく移植することが非常に難しかったです。
私が担当していたソフトウェアはVS2003環境で約20年経っているものでした。そのため、アップデートロジックの部分が当時までリファクタリングされておらず、新しい機能を簡単に追加できない状況でした。したがって、新入社員の私がコードをすべて分析し、新機能を挿入、そしてテスト環境を構築することが大変でした。

そこで、まず開発したい機能だけをVS2019環境で静的ライブラリに作りました。そして、グーグルテストライブラリとnginxウェブサーバーで事前に作成したパッチファイルを活用し、自動的にテストを行いました。それで、安定性を確認した後、該当機能を既存VS2003上のアップデートロジックに追加し全体動作を確認しました。

しかし、配布結果、既存トラフィックがむしろ 3 倍に増加しました。
自動アップデート時、プログラムがアップデートを3回以上試みたのが問題でした。そのため、私の増分アップデートコードが3回以上動作して異常なトラフィックが発生したのです。
私は問題を迅速に会社に知らせ、ロールバックさせました。その後、既存アップデートロジックを詳しく確認し、end-to-endテストを自動化しました。そして安定性点検の後、再配布した結果、トラフィックを問題なく削減できました。
